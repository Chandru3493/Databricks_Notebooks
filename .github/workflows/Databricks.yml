name: Databricks Deployment

on:
  push:
    branches:
      - Dev
      - main

jobs:
  deploy-Dev:
    if: github.ref == 'refs/heads/Dev'
    runs-on: self-hosted

    steps:
      - name: Check if Databricks CLI is installed
        run: |
          if (-not (Get-Command databricks -ErrorAction SilentlyContinue)) {
            Write-Host "Databricks CLI not found, installing..."
            Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
            databricks -v
          } else {
            Write-Host "Databricks CLI is already installed."
          }

      - name: Authenticate Dev Databricks Workspace
        run: |
          New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.databricks
          @"
          [DEFAULT]
          host = https://adb-2990609490919825.5.azuredatabricks.net
          token = dapi121fb6bd3b99b53941513362eb45ec3b-3
          "@ | Out-File -FilePath "$env:USERPROFILE\.databrickscfg" -Encoding utf8
          icacls "$env:USERPROFILE\.databrickscfg" /inheritance:r /grant:r "$env:USERNAME`:F"
          databricks auth profiles

      - name: Fetch Notebooks folder
        run: |
          if (Test-Path -Path "./Databricks") {
            Write-Host "Notebooks folder found."
          } else {
            Write-Host "Notebooks folder not found!"
            exit 1
          }

      - name: Sync Notebooks folder to Databricks Workspace
        run: |
          $localPath = "./Notebooks"
          $remotePath = "/Workspace/Users/your-username/Notebooks"
          Get-ChildItem -Path $localPath -Recurse | ForEach-Object {
            if ($_.PSIsContainer) {
              databricks sync "$($_.FullName)" "$remotePath/$($_.Name)"
            }
          }

      - name: Completion message
        run: |
          Write-Host "Sync completed successfully."
          
  # deploy-prod:
  #   if: github.ref == 'refs/heads/main'
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Install Databricks CLI
  #       run: |
  #         echo "Hello World"
